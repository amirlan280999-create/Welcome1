import time
import os
import multiprocessing
from concurrent.futures import ProcessPoolExecutor

class SaladOrder:
    def __init__(self, id, name, complexity):
        self.id = id
        self.name = name
        self.complexity = complexity  # –ù–∞—Å–∫–æ–ª—å–∫–æ —Ç—è–∂–µ–ª–æ —Ä–µ–∑–∞—Ç—å (–º–ª–Ω –æ–ø–µ—Ä–∞—Ü–∏–π)

    def __repr__(self):
        return f"–°–∞–ª–∞—Ç '{self.name}'"



# 2. –§–£–ù–ö–¶–ò–Ø –ü–û–í–ê–†–ê (–†–∞–±–æ—á–∞—è –ª–æ—à–∞–¥–∫–∞)
# –í multiprocessing —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º —É—Ä–æ–≤–Ω–µ (–Ω–µ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Å–∞),
# —á—Ç–æ–±—ã Python –º–æ–≥ –∏—Ö "–∑–∞–∫–æ–Ω—Å–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å" (pickle) –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å.

def prepare_salad(order, shared_knife_sem):
    # –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ—Ü–µ—Å—Å–∞ (PID). –û–Ω –±—É–¥–µ—Ç –†–ê–ó–ù–´–ô —É –≤—Å–µ—Ö!
    pid = os.getpid()

    print(f"   üë®‚Äçüç≥ [PID:{pid}] –ü–æ–ª—É—á–∏–ª –∑–∞–∫–∞–∑: {order}. –ò—â—É –Ω–æ–∂...")

    # 1. –ü—ã—Ç–∞–µ–º—Å—è –≤–∑—è—Ç—å –Ω–æ–∂ (–°–µ–º–∞—Ñ–æ—Ä —á–µ—Ä–µ–∑ –ú–µ–Ω–µ–¥–∂–µ—Ä–∞)
    # –ï—Å–ª–∏ –Ω–æ–∂–µ–π –Ω–µ—Ç, –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–∞–ª—å–Ω–æ –∑–∞—Å—ã–ø–∞–µ—Ç –∏ –∂–¥–µ—Ç —Ç—É—Ç.
    with shared_knife_sem:
        print(f"   üî™ [PID:{pid}] –í–∑—è–ª –Ω–æ–∂! –ù–∞—á–∞–ª —Ä–µ–∑–∞—Ç—å {order.name}...")

        # 2. –¢–Ø–ñ–ï–õ–ê–Ø –†–ê–ë–û–¢–ê (CPU Bound)
        # –≠—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –≥—Ä–µ–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä. GIL –∑–¥–µ—Å—å –Ω–µ –º–µ—à–∞–µ—Ç.
        start_cut = time.time()

        # –≠–º—É–ª—è—Ü–∏—è: —Å—á–∏—Ç–∞–µ–º —Å–ª–æ–∂–Ω—ã–µ —á–∏—Å–ª–∞
        count = 0
        # –ß–µ–º –≤—ã—à–µ complexity, —Ç–µ–º –¥–æ–ª—å—à–µ —Ü–∏–∫–ª
        for i in range(order.complexity * 1_000_000):
            count += i * i

        duration = time.time() - start_cut

        print(f"   ‚úÖ [PID:{pid}] –ì–æ—Ç–æ–≤–æ! {order.name} –Ω–∞—Ä–µ–∑–∞–Ω –∑–∞ {duration:.2f} —Å–µ–∫.")
        return f"{order.name} (–≤—ã–ø–æ–ª–Ω–∏–ª PID {pid})"



# 3. –ó–ê–ü–£–°–ö –¶–ï–•–ê
if __name__ == "__main__":
    # –í Windows —ç—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ! –ò–Ω–∞—á–µ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∞–¥.

    # --- –ù–ê–°–¢–†–û–ô–ö–ê –¶–ï–•–ê ---
    orders = [
        SaladOrder(1, "–û–ª–∏–≤—å–µ", 15),  # –°–ª–æ–∂–Ω—ã–π
        SaladOrder(2, "–¶–µ–∑–∞—Ä—å", 10),  # –°—Ä–µ–¥–Ω–∏–π
        SaladOrder(3, "–ì—Ä–µ—á–µ—Å–∫–∏–π", 10),  # –°—Ä–µ–¥–Ω–∏–π
        SaladOrder(4, "–í–∏–Ω–µ–≥—Ä–µ—Ç", 20),  # –û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π
        SaladOrder(5, "–ö—Ä–∞–±–æ–≤—ã–π", 5),  # –õ–µ–≥–∫–∏–π
    ]

    TOTAL_KNIVES = 2  # –í—Å–µ–≥–æ 2 –Ω–æ–∂–∞ –Ω–∞ –≤—Å–µ—Ö
    MAX_COOKS = 3  # –ù–∞–Ω–∏–º–∞–µ–º 3 –ø–æ–≤–∞—Ä–∞

    print(f"üè≠ –¶–ï–• –û–¢–ö–†–´–¢. –ó–∞–∫–∞–∑–æ–≤: {len(orders)}. –ü–æ–≤–∞—Ä–æ–≤: {MAX_COOKS}. –ù–æ–∂–µ–π: {TOTAL_KNIVES}")

    # --- –ú–ê–ì–ò–Ø –ú–ï–ù–ï–î–ñ–ï–†–ê ---
    # –ú—ã —Å–æ–∑–¥–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç –∂–∏—Ç—å –º–µ–∂–¥—É –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.
    with multiprocessing.Manager() as manager:

        # –°–æ–∑–¥–∞–µ–º –°–µ–º–∞—Ñ–æ—Ä –í–ù–£–¢–†–ò –ú–µ–Ω–µ–¥–∂–µ—Ä–∞.
        # –¢–µ–ø–µ—Ä—å —ç—Ç–æ "–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—â–∏–π —Å–µ–º–∞—Ñ–æ—Ä", –∞ –Ω–µ –∫–æ–ø–∏—è.
        shared_knives = manager.Semaphore(TOTAL_KNIVES)

        # –ó–∞–ø—É—Å–∫–∞–µ–º ProcessPoolExecutor
        with ProcessPoolExecutor(max_workers=MAX_COOKS) as executor:

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á–∏
            # –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: –º—ã –ø–µ—Ä–µ–¥–∞–µ–º shared_knives –≤ –∫–∞–∂–¥—ã–π –ø—Ä–æ—Ü–µ—Å—Å
            futures = []
            for order in orders:
                # submit(—Ñ—É–Ω–∫—Ü–∏—è, –∞—Ä–≥—É–º–µ–Ω—Ç1, –∞—Ä–≥—É–º–µ–Ω—Ç2...)
                ft = executor.submit(prepare_salad, order, shared_knives)
                futures.append(ft)

            # –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –º–µ—Ä–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            for f in futures:
                # result() –≤–µ—Ä–Ω–µ—Ç —Ç–æ, —á—Ç–æ –≤–µ—Ä–Ω—É–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è prepare_salad
                res = f.result()
                # print(f"--- –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–∏–Ω—è–ª –Ω–∞ —Å–∫–ª–∞–¥: {res} ---")

    print("üèÅ –°–º–µ–Ω–∞ –æ–∫–æ–Ω—á–µ–Ω–∞. –í—Å–µ —Å–∞–ª–∞—Ç—ã –Ω–∞—Ä–µ–∑–∞–Ω—ã.")